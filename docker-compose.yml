services:
  user-db:
    image: mongo
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: secret
    volumes:
      - user-data:/data/db

  student-db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: studentdb
    ports:
      - "5432:5432"
    volumes:
      - student_data:/var/lib/postgresql/data

  class-db:
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: secret
      POSTGRES_DB: classdb
    ports:
      - "5432:5432"
    volumes:
      - class_data:/var/lib/postgresql/data

  auth:
    build:
      context: ./auth-service
      target: development
    ports:
      - '3001:3001'
    volumes:
      - ./auth-service:/app:delegated
      - /app/node_modules
    env_file:
      - './auth-service/.env'
    environment:
      - MONGO_USERNAME=admin
      - MONGO_PASSWORD=secret
      - MONGO_HOST=user-db
      - MONGO_DB=userdb
    depends_on:
      - user-db

  student:
    build:
      context: ./student-service
      target: development
    ports:
      - '3002:3002'
    volumes:
      - ./student-service:/app:delegated
      - /app/node_modules
    env_file:
      - './student-service/.env'
    environment:
      - DATABASE_URL=postgresql://admin:secret@student-db:5432/studentdb?schema=public
    depends_on:
      - student-db
      - auth

  class:
    build:
      context: ./class-service
      target: development
    ports:
      - '3002:3002'
    volumes:
      - ./class-service:/app:delegated
      - /app/node_modules
    env_file:
      - './class-service/.env'
    environment:
      - DATABASE_URL=postgresql://admin:secret@student-db:5432/classdb?schema=public
    depends_on:
      - class-db
      - auth
volumes:
  user-data:
  student_data:
  class_data: